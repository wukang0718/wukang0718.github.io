<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>reactive源码 | 前端武康</title><meta name="description" content="源码位置： https:&#x2F;&#x2F;github.com&#x2F;vuejs&#x2F;vue-next&#x2F;blob&#x2F;master&#x2F;packages&#x2F;reactivity&#x2F;src&#x2F;reactive.ts  reactive 方法接收一个对象，返回 对象深代理，通过 createReactiveObject 方法  对象的 reactive 代理，会被缓存，所以对同一个对象执行多次 reactive 返回的是同一个值  示例"><meta property="og:type" content="article"><meta property="og:title" content="reactive源码"><meta property="og:url" content="https://wukang0718.com/2022/09/02/reactive%E6%BA%90%E7%A0%81/"><meta property="og:site_name" content="前端武康"><meta property="og:description" content="源码位置： https:&#x2F;&#x2F;github.com&#x2F;vuejs&#x2F;vue-next&#x2F;blob&#x2F;master&#x2F;packages&#x2F;reactivity&#x2F;src&#x2F;reactive.ts  reactive 方法接收一个对象，返回 对象深代理，通过 createReactiveObject 方法  对象的 reactive 代理，会被缓存，所以对同一个对象执行多次 reactive 返回的是同一个值  示例"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-09-02T08:59:27.000Z"><meta property="article:modified_time" content="2022-09-02T08:59:54.688Z"><meta property="article:author" content="武康"><meta property="article:tag" content="vue3"><meta property="article:tag" content="reactive"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://wukang0718.com/2022/09/02/reactive%E6%BA%90%E7%A0%81/index.html"><link rel="alternate" href="/atom.xml" title="前端武康" type="application/atom+xml"><link rel="icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://giteement.oss-cn-beijing.aliyuncs.com/default.css"><meta name="generator" content="Hexo 5.4.0"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/wukang0718" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpeg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">武康</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">前端开发</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> BeiJing, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/wukang0718" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">文章目录</h3><div class="widget-body"><nav id="toc" class="article-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#reactive-%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">reactive 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mutableHandlers"><span class="toc-number">1.1.</span> <span class="toc-text">mutableHandlers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createGetter"><span class="toc-number">1.1.1.</span> <span class="toc-text">createGetter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createSetter"><span class="toc-number">1.1.2.</span> <span class="toc-text">createSetter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mutableCollectionHandlers"><span class="toc-number">1.1.3.</span> <span class="toc-text">mutableCollectionHandlers</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createInstrumentationGetter"><span class="toc-number">1.2.</span> <span class="toc-text">createInstrumentationGetter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#instrumentations-gt-mutableInstrumentations"><span class="toc-number">1.2.1.</span> <span class="toc-text">instrumentations &#x3D;&gt; mutableInstrumentations</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#get"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">get</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#toReactive"><span class="toc-number">1.2.1.1.1.</span> <span class="toc-text">toReactive</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#size"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">size</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#has"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">has</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#add"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">add</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">set</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#delete"><span class="toc-number">1.2.1.6.</span> <span class="toc-text">delete</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#clear"><span class="toc-number">1.2.1.7.</span> <span class="toc-text">clear</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#forEach"><span class="toc-number">1.2.1.8.</span> <span class="toc-text">forEach</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#keys-%E3%80%81values%E3%80%81entries"><span class="toc-number">1.2.1.9.</span> <span class="toc-text">keys 、values、entries</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#createIterableMethod"><span class="toc-number">1.2.1.9.1.</span> <span class="toc-text">createIterableMethod</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shallowReactive-%E6%96%B9%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">shallowReactive 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shallowReactiveHandlers"><span class="toc-number">2.1.</span> <span class="toc-text">shallowReactiveHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shallowCollectionHandlers"><span class="toc-number">2.2.</span> <span class="toc-text">shallowCollectionHandlers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#readonly-%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">readonly 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#readonlyHandlers"><span class="toc-number">3.1.</span> <span class="toc-text">readonlyHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readonlyCollectionHandlers"><span class="toc-number">3.2.</span> <span class="toc-text">readonlyCollectionHandlers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shallowReadonly-%E6%96%B9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">shallowReadonly 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shallowReadonlyHandlers"><span class="toc-number">4.1.</span> <span class="toc-text">shallowReadonlyHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readonlyCollectionHandlers-1"><span class="toc-number">4.2.</span> <span class="toc-text">readonlyCollectionHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createReactiveObject-%E6%96%B9%E6%B3%95"><span class="toc-number">4.3.</span> <span class="toc-text">createReactiveObject 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#isReactive-%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">isReactive 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#isReadonly-%E6%96%B9%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text">isReadonly 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#isProxy-%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">isProxy 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#toRaw-%E6%96%B9%E6%B3%95"><span class="toc-number">8.</span> <span class="toc-text">toRaw 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#markRaw-%E6%96%B9%E6%B3%95"><span class="toc-number">9.</span> <span class="toc-text">markRaw 方法</span></a></li></ol></nav></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Vue%E6%8F%92%E4%BB%B6/">Vue插件</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/vue/vue3/">vue3</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/vue/vue3/vue2%E5%8D%87%E7%BA%A7vue3/">vue2升级vue3</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/vue3%E9%A1%B9%E7%9B%AE/">vue3项目</a><span class="category-list-count">6</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue3/">vue3</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a><span class="category-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/EventLoop/" rel="tag">EventLoop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/build/" rel="tag">build</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/computed/" rel="tag">computed</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/createApp/" rel="tag">createApp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/effect/" rel="tag">effect</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reactive/" rel="tag">reactive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ref/" rel="tag">ref</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-cli/" rel="tag">vue-cli</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-router/" rel="tag">vue-router</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue2%E5%8D%87%E7%BA%A7vue3/" rel="tag">vue2升级vue3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue3/" rel="tag">vue3</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%8F%E4%BB%BB%E5%8A%A1/" rel="tag">宏任务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%AE%E4%BB%BB%E5%8A%A1/" rel="tag">微任务</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/EventLoop/" style="font-size:13px">EventLoop</a> <a href="/tags/build/" style="font-size:13px">build</a> <a href="/tags/computed/" style="font-size:13px">computed</a> <a href="/tags/createApp/" style="font-size:13px">createApp</a> <a href="/tags/effect/" style="font-size:13px">effect</a> <a href="/tags/reactive/" style="font-size:13px">reactive</a> <a href="/tags/ref/" style="font-size:13px">ref</a> <a href="/tags/vue/" style="font-size:13px">vue</a> <a href="/tags/vue-cli/" style="font-size:13.5px">vue-cli</a> <a href="/tags/vue-router/" style="font-size:13px">vue-router</a> <a href="/tags/vue2%E5%8D%87%E7%BA%A7vue3/" style="font-size:13px">vue2升级vue3</a> <a href="/tags/vue3/" style="font-size:14px">vue3</a> <a href="/tags/%E5%AE%8F%E4%BB%BB%E5%8A%A1/" style="font-size:13px">宏任务</a> <a href="/tags/%E5%BE%AE%E4%BB%BB%E5%8A%A1/" style="font-size:13px">微任务</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">8</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/vue3/">vue3</a></p><p class="item-title"><a href="/2022/09/02/ref%E6%BA%90%E7%A0%81/" class="title">ref源码</a></p><p class="item-date"><time datetime="2022-09-02T09:00:25.000Z" itemprop="datePublished">2022-09-02</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/vue3/">vue3</a></p><p class="item-title"><a href="/2022/09/02/reactive%E6%BA%90%E7%A0%81/" class="title">reactive源码</a></p><p class="item-date"><time datetime="2022-09-02T08:59:27.000Z" itemprop="datePublished">2022-09-02</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/vue3/">vue3</a></p><p class="item-title"><a href="/2022/09/02/computed%E6%BA%90%E7%A0%81/" class="title">computed源码</a></p><p class="item-date"><time datetime="2022-09-02T08:58:18.000Z" itemprop="datePublished">2022-09-02</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/vue3/">vue3</a></p><p class="item-title"><a href="/2022/09/02/effect%E6%BA%90%E7%A0%81/" class="title">effect源码</a></p><p class="item-date"><time datetime="2022-09-02T08:57:22.000Z" itemprop="datePublished">2022-09-02</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/vue3/">vue3</a></p><p class="item-title"><a href="/2022/09/02/createApp%E6%BA%90%E7%A0%81/" class="title">createApp源码</a></p><p class="item-date"><time datetime="2022-09-02T08:52:20.000Z" itemprop="datePublished">2022-09-02</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#reactive-%E6%96%B9%E6%B3%95"><span class="toc-number">1.</span> <span class="toc-text">reactive 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mutableHandlers"><span class="toc-number">1.1.</span> <span class="toc-text">mutableHandlers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createGetter"><span class="toc-number">1.1.1.</span> <span class="toc-text">createGetter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#createSetter"><span class="toc-number">1.1.2.</span> <span class="toc-text">createSetter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mutableCollectionHandlers"><span class="toc-number">1.1.3.</span> <span class="toc-text">mutableCollectionHandlers</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createInstrumentationGetter"><span class="toc-number">1.2.</span> <span class="toc-text">createInstrumentationGetter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#instrumentations-gt-mutableInstrumentations"><span class="toc-number">1.2.1.</span> <span class="toc-text">instrumentations &#x3D;&gt; mutableInstrumentations</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#get"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">get</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#toReactive"><span class="toc-number">1.2.1.1.1.</span> <span class="toc-text">toReactive</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#size"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">size</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#has"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">has</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#add"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">add</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#set"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">set</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#delete"><span class="toc-number">1.2.1.6.</span> <span class="toc-text">delete</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#clear"><span class="toc-number">1.2.1.7.</span> <span class="toc-text">clear</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#forEach"><span class="toc-number">1.2.1.8.</span> <span class="toc-text">forEach</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#keys-%E3%80%81values%E3%80%81entries"><span class="toc-number">1.2.1.9.</span> <span class="toc-text">keys 、values、entries</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#createIterableMethod"><span class="toc-number">1.2.1.9.1.</span> <span class="toc-text">createIterableMethod</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shallowReactive-%E6%96%B9%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">shallowReactive 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shallowReactiveHandlers"><span class="toc-number">2.1.</span> <span class="toc-text">shallowReactiveHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shallowCollectionHandlers"><span class="toc-number">2.2.</span> <span class="toc-text">shallowCollectionHandlers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#readonly-%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">readonly 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#readonlyHandlers"><span class="toc-number">3.1.</span> <span class="toc-text">readonlyHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readonlyCollectionHandlers"><span class="toc-number">3.2.</span> <span class="toc-text">readonlyCollectionHandlers</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shallowReadonly-%E6%96%B9%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">shallowReadonly 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shallowReadonlyHandlers"><span class="toc-number">4.1.</span> <span class="toc-text">shallowReadonlyHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#readonlyCollectionHandlers-1"><span class="toc-number">4.2.</span> <span class="toc-text">readonlyCollectionHandlers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#createReactiveObject-%E6%96%B9%E6%B3%95"><span class="toc-number">4.3.</span> <span class="toc-text">createReactiveObject 方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#isReactive-%E6%96%B9%E6%B3%95"><span class="toc-number">5.</span> <span class="toc-text">isReactive 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#isReadonly-%E6%96%B9%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text">isReadonly 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#isProxy-%E6%96%B9%E6%B3%95"><span class="toc-number">7.</span> <span class="toc-text">isProxy 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#toRaw-%E6%96%B9%E6%B3%95"><span class="toc-number">8.</span> <span class="toc-text">toRaw 方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#markRaw-%E6%96%B9%E6%B3%95"><span class="toc-number">9.</span> <span class="toc-text">markRaw 方法</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-reactive源码" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">reactive源码</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2022/09/02/reactive%E6%BA%90%E7%A0%81/" class="article-date"><time datetime="2022-09-02T08:59:27.000Z" itemprop="datePublished">2022-09-02</time> </a></span><span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/vue3/">vue3</a> </span><span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link-link" href="/tags/reactive/" rel="tag">reactive</a>, <a class="article-tag-link-link" href="/tags/vue3/" rel="tag">vue3</a> </span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/09/02/reactive%E6%BA%90%E7%A0%81/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 4.4k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 21(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><blockquote><p>源码位置： <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-next/blob/master/packages/reactivity/src/reactive.ts">https://github.com/vuejs/vue-next/blob/master/packages/reactivity/src/reactive.ts</a></p></blockquote><h2 id="reactive-方法"><a href="#reactive-方法" class="headerlink" title="reactive 方法"></a>reactive 方法</h2><p>接收一个对象，返回 对象深代理，通过 <code>createReactiveObject</code> 方法</p><ul><li>对象的 <code>reactive</code> 代理，会被缓存，所以对同一个对象执行多次 <code>reactive</code> 返回的是同一个值</li></ul><p>示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = &#123;<span class="attr">b</span>: <span class="number">12</span>&#125;</span><br><span class="line">    <span class="keyword">const</span> reactive1 = Vue.reactive(a)</span><br><span class="line">    <span class="keyword">const</span> reactive2 = Vue.reactive(a)</span><br><span class="line">    <span class="built_in">console</span>.log(reactive1 === reactive2) <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>如果对象是 <code>readonly</code> 类型的，就返回对象本身</li></ul><p>示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = &#123;<span class="attr">b</span>: <span class="number">12</span>&#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">readonly</span> = Vue.readonly(a)</span><br><span class="line">    <span class="keyword">const</span> reactive = Vue.reactive(<span class="keyword">readonly</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">readonly</span> === reactive) <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">reactive</span>(<span class="params">target: <span class="built_in">object</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (target &amp;&amp; (target <span class="keyword">as</span> Target)[ReactiveFlags.IS_READONLY]) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(</span><br><span class="line">    target,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    mutableHandlers,</span><br><span class="line">    mutableCollectionHandlers</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mutableHandlers"><a href="#mutableHandlers" class="headerlink" title="mutableHandlers"></a>mutableHandlers</h3><p>在 <code>target</code> 是一个正常的 <code>Object</code> 或者 <code>Array</code> 时，使用这个对象做 <code>proxy</code> 的 <code>handle</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> get = <span class="comment">/*#__PURE__*/</span> createGetter() <span class="comment">// 在下面</span></span><br><span class="line"><span class="keyword">const</span> set = <span class="comment">/*#__PURE__*/</span> createSetter() <span class="comment">// 在下面</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// delete / Reflect.deleteProperty() 操作符的时候调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteProperty</span>(<span class="params">target: <span class="built_in">object</span>, key: <span class="built_in">string</span> | symbol</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hadKey = hasOwn(target, key) <span class="comment">// Object.prototype.hasOwnProperty</span></span><br><span class="line">  <span class="keyword">const</span> oldValue = (target <span class="keyword">as</span> <span class="built_in">any</span>)[key]</span><br><span class="line">  <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.deleteProperty(target, key)</span><br><span class="line">  <span class="keyword">if</span> (result &amp;&amp; hadKey) &#123;</span><br><span class="line">    <span class="comment">// 如果删除成功，触发依赖更新 </span></span><br><span class="line">    trigger(target, TriggerOpTypes.DELETE, key, <span class="literal">undefined</span>, oldValue)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// in / Reflect.has() 操作符调用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">has</span>(<span class="params">target: <span class="built_in">object</span>, key: <span class="built_in">string</span> | symbol</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.has(target, key)</span><br><span class="line">  <span class="keyword">if</span> (!isSymbol(key) || !builtInSymbols.has(key)) &#123;</span><br><span class="line">    <span class="comment">// key 和 value 不是 symbol 类型 收集依赖</span></span><br><span class="line">    track(target, TrackOpTypes.HAS, key)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** 拦截下面操作</span></span><br><span class="line"><span class="comment">	Object.getOwnPropertyNames()</span></span><br><span class="line"><span class="comment">    Object.getOwnPropertySymbols()</span></span><br><span class="line"><span class="comment">    Object.keys()</span></span><br><span class="line"><span class="comment">    Reflect.ownKeys()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ownKeys</span>(<span class="params">target: <span class="built_in">object</span></span>): (<span class="params"><span class="built_in">string</span> | <span class="built_in">number</span> | symbol</span>)[] </span>&#123;</span><br><span class="line">  track(target, TrackOpTypes.ITERATE, isArray(target) ? <span class="string">&#x27;length&#x27;</span> : ITERATE_KEY)</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Reflect</span>.ownKeys(target)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutableHandlers: ProxyHandler&lt;<span class="built_in">object</span>&gt; = &#123;</span><br><span class="line">  get,</span><br><span class="line">  set,</span><br><span class="line">  deleteProperty,</span><br><span class="line">  has,</span><br><span class="line">  ownKeys</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="createGetter"><a href="#createGetter" class="headerlink" title="createGetter"></a>createGetter</h4><p>参数接收 <code>isReadonly</code> 是否只读， <code>shallow</code> 是否只做前代理， 返回一个 <code>get</code> 函数</p><p>当返回值时一个对象，并且 <code>shallow</code> 为 false 时，会对返回值再做一次 <code>readonly</code> 或者 <code>reactive</code> 处理，实现深代理</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 get 函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 只读</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>shallow 浅代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGetter</span>(<span class="params">isReadonly = <span class="literal">false</span>, shallow = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">target: Target, key: <span class="built_in">string</span> | symbol, receiver: <span class="built_in">object</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key === ReactiveFlags.IS_REACTIVE) &#123;</span><br><span class="line">      <span class="comment">// 这个key __v_isReactive 表示对象是不是 reactive 类型</span></span><br><span class="line">      <span class="keyword">return</span> !isReadonly</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === ReactiveFlags.IS_READONLY) &#123;</span><br><span class="line">      <span class="comment">// 这个key __v_isReadonly 表示对象是不是只读类型</span></span><br><span class="line">      <span class="keyword">return</span> isReadonly</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      key === ReactiveFlags.RAW &amp;&amp;</span><br><span class="line">      receiver === (isReadonly ? readonlyMap : reactiveMap).get(target)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// 这个keym __v_raw 获取 代理的源对象</span></span><br><span class="line">      <span class="keyword">return</span> target</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 上面的三个 特殊值，在 is 开头的函数 和 to 开头的函数中用到</span></span><br><span class="line">    <span class="comment">// 例：isReactive / toRaw</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> targetIsArray = isArray(target)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不是只读，是数组，并且调用了数组的方法，需要特殊的方法处理</span></span><br><span class="line">    <span class="keyword">if</span> (!isReadonly &amp;&amp; targetIsArray &amp;&amp; hasOwn(arrayInstrumentations, key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(arrayInstrumentations, key, receiver)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.get(target, key, receiver)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// key 是 symbol 类型，并且值也是 symbol 或者 获取的是  __proto__ 或者 __v_isRef 时</span></span><br><span class="line">    <span class="comment">// 直接返回结果</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      isSymbol(key)</span><br><span class="line">        ? builtInSymbols.has(key <span class="keyword">as</span> symbol)</span><br><span class="line">        : key === <span class="string">`__proto__`</span> || key === <span class="string">`__v_isRef`</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不是只读的数据，收集依赖</span></span><br><span class="line">    <span class="keyword">if</span> (!isReadonly) &#123;</span><br><span class="line">      track(target, TrackOpTypes.GET, key)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 浅代理，返回结果</span></span><br><span class="line">    <span class="keyword">if</span> (shallow) &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isRef(res)) &#123;</span><br><span class="line">      <span class="comment">// ref展开-不适用于数组 和 整数键。</span></span><br><span class="line">      <span class="keyword">const</span> shouldUnwrap = !targetIsArray || !isIntegerKey(key)</span><br><span class="line">      <span class="comment">// 这里对 ref 做了 返回原始值的处理</span></span><br><span class="line">      <span class="keyword">return</span> shouldUnwrap ? res.value : res</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果结果时对象，对这个对象在做一次 reactive 处理，实现深代理</span></span><br><span class="line">    <span class="keyword">if</span> (isObject(res)) &#123;</span><br><span class="line">      <span class="comment">// Convert returned value into a proxy as well. we do the isObject check</span></span><br><span class="line">      <span class="comment">// here to avoid invalid value warning. Also need to lazy access readonly</span></span><br><span class="line">      <span class="comment">// and reactive here to avoid circular dependency.</span></span><br><span class="line">      <span class="keyword">return</span> isReadonly ? <span class="keyword">readonly</span>(res) : reactive(res)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里用到了一个特殊的值 <code>arrayInstrumentations</code></p><p>这个值表示需要特殊处理的 <code>Array</code> 的方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数组的一些方法需要做特殊的处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> arrayInstrumentations: Record&lt;<span class="built_in">string</span>, <span class="built_in">Function</span>&gt; = &#123;&#125;</span><br><span class="line">;([<span class="string">&#x27;includes&#x27;</span>, <span class="string">&#x27;indexOf&#x27;</span>, <span class="string">&#x27;lastIndexOf&#x27;</span>] <span class="keyword">as</span> <span class="keyword">const</span>).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> method = <span class="built_in">Array</span>.prototype[key] <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  arrayInstrumentations[key] = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">this</span>: unknown[], ...args: unknown[]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = toRaw(<span class="built_in">this</span>) <span class="comment">// 获取到数组的原值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = <span class="built_in">this</span>.length; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="comment">// 循环对数组中的每一项添加依赖</span></span><br><span class="line">      track(arr, TrackOpTypes.GET, i + <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 先不对参数做处理，直接运行方法</span></span><br><span class="line">    <span class="keyword">const</span> res = method.apply(arr, args)</span><br><span class="line">    <span class="keyword">if</span> (res === -<span class="number">1</span> || res === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果方法没有期望的返回值，在对参数做一次 toRaw（获取原始值） 转换</span></span><br><span class="line">      <span class="keyword">return</span> method.apply(arr, args.map(toRaw))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 这些方法会改变 Array 的length 属性，在某种情况下，会导致依赖循环触发 #2137</span></span><br><span class="line">;([<span class="string">&#x27;push&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;unshift&#x27;</span>, <span class="string">&#x27;splice&#x27;</span>] <span class="keyword">as</span> <span class="keyword">const</span>).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> method = <span class="built_in">Array</span>.prototype[key] <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  arrayInstrumentations[key] = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">this</span>: unknown[], ...args: unknown[]</span>) </span>&#123;</span><br><span class="line">    pauseTracking() <span class="comment">// 停止依赖收集</span></span><br><span class="line">    <span class="keyword">const</span> res = method.apply(<span class="built_in">this</span>, args) <span class="comment">// 获取到处理结果</span></span><br><span class="line">    resetTracking() <span class="comment">// 恢复依赖收集</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="createSetter"><a href="#createSetter" class="headerlink" title="createSetter"></a>createSetter</h4><p>函数接收一个参数 <code>shallow</code> ，是否只做浅代理，返回一个 <code>set</code> 函数</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 set 方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>shallow 是否做浅代理操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSetter</span>(<span class="params">shallow = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    target: <span class="built_in">object</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    key: <span class="built_in">string</span> | symbol,</span></span></span><br><span class="line"><span class="params"><span class="function">    value: unknown,</span></span></span><br><span class="line"><span class="params"><span class="function">    receiver: <span class="built_in">object</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">boolean</span> </span>&#123; </span><br><span class="line">    <span class="keyword">const</span> oldValue = (target <span class="keyword">as</span> <span class="built_in">any</span>)[key]</span><br><span class="line">    <span class="keyword">if</span> (!shallow) &#123;</span><br><span class="line">      value = toRaw(value)</span><br><span class="line">      <span class="comment">// 深代理模式下，如果数组中的每一项都是 ref 对象，修改只修改该项的 value 值，不替换整个对象</span></span><br><span class="line">      <span class="keyword">if</span> (!isArray(target) &amp;&amp; isRef(oldValue) &amp;&amp; !isRef(value)) &#123;</span><br><span class="line">        oldValue.value = value</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// in shallow mode, objects are set as-is regardless of reactive or not</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断 key 是数组的下标或者 对象/数组的属性</span></span><br><span class="line">    <span class="keyword">const</span> hadKey =</span><br><span class="line">      isArray(target) &amp;&amp; isIntegerKey(key)</span><br><span class="line">        ? <span class="built_in">Number</span>(key) &lt; target.length</span><br><span class="line">        : hasOwn(target, key)</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Reflect</span>.set(target, key, value, receiver)</span><br><span class="line">    <span class="comment">// don&#x27;t trigger if target is something up in the prototype chain of original</span></span><br><span class="line">    <span class="comment">// 不能直接触发依赖更新，有可能是原型链上的proxy被调用</span></span><br><span class="line">    <span class="comment">// 要判断 receiver 的原始值，就是当前的target对象， 这样确保是当前的 target 的 proxy 被触发</span></span><br><span class="line">    <span class="keyword">if</span> (target === toRaw(receiver)) &#123;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">        <span class="comment">// 没有 key 的情况是添加属性，或者 数组添加一项</span></span><br><span class="line">        trigger(target, TriggerOpTypes.ADD, key, value)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasChanged(value, oldValue)) &#123;</span><br><span class="line">        <span class="comment">// 有 key 并且 新旧值不一样，修改成功，需要触发 set 的依赖</span></span><br><span class="line">        trigger(target, TriggerOpTypes.SET, key, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mutableCollectionHandlers"><a href="#mutableCollectionHandlers" class="headerlink" title="mutableCollectionHandlers"></a>mutableCollectionHandlers</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mutableCollectionHandlers: ProxyHandler&lt;CollectionTypes&gt; = &#123;</span><br><span class="line">  <span class="attr">get</span>: createInstrumentationGetter(<span class="literal">false</span>, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="createInstrumentationGetter"><a href="#createInstrumentationGetter" class="headerlink" title="createInstrumentationGetter"></a>createInstrumentationGetter</h3><p>接收两个参数 <code>isReadonly</code> 是否只读和 <code>shallow</code> 是否浅代理</p><p>返回一个 <code>get</code> 方法，这里是对 <code>Map.</code> 的代理，<code>get</code> 方法中对 <code>set</code>/<code>has</code>…方法做了处理，通过 <code>instrumentations</code> 对象</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个 Collection 的get 函数，在 get 中，对 set/has... 方法做处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 是否只读</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>shallow 是否浅代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createInstrumentationGetter</span>(<span class="params">isReadonly: <span class="built_in">boolean</span>, shallow: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instrumentations = shallow</span><br><span class="line">    ? shallowInstrumentations</span><br><span class="line">    : isReadonly</span><br><span class="line">      ? readonlyInstrumentations</span><br><span class="line">      : mutableInstrumentations</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    target: CollectionTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">    key: <span class="built_in">string</span> | symbol,</span></span></span><br><span class="line"><span class="params"><span class="function">    receiver: CollectionTypes</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === ReactiveFlags.IS_REACTIVE) &#123;</span><br><span class="line">      <span class="keyword">return</span> !isReadonly</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === ReactiveFlags.IS_READONLY) &#123;</span><br><span class="line">      <span class="keyword">return</span> isReadonly</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === ReactiveFlags.RAW) &#123;</span><br><span class="line">      <span class="keyword">return</span> target</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理三个特殊 key 在 is... 和 to... 的方法中用到</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是 instrumentations 中有的方法，并且是 target 中的原始存在的方法，就使用代理，否则直接放回对象本身的值</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(</span><br><span class="line">      hasOwn(instrumentations, key) &amp;&amp; key <span class="keyword">in</span> target</span><br><span class="line">        ? instrumentations</span><br><span class="line">        : target,</span><br><span class="line">      key,</span><br><span class="line">      receiver</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="instrumentations-gt-mutableInstrumentations"><a href="#instrumentations-gt-mutableInstrumentations" class="headerlink" title="instrumentations  =&gt; mutableInstrumentations"></a>instrumentations =&gt; mutableInstrumentations</h4><p>返回了一个 <code>handle</code> 的对象，对象方法中的 <code>this</code>，都是指向 <code>reactive</code> 对象</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mutableInstrumentations: Record&lt;<span class="built_in">string</span>, <span class="built_in">Function</span>&gt; = &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params"><span class="built_in">this</span>: MapTypes, key: unknown</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> get(<span class="built_in">this</span>, key)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">get</span> <span class="title">size</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> size((<span class="built_in">this</span> <span class="keyword">as</span> unknown) <span class="keyword">as</span> IterableCollections)</span><br><span class="line">  &#125;,</span><br><span class="line">  has,</span><br><span class="line">  add,</span><br><span class="line">  set,</span><br><span class="line">  <span class="attr">delete</span>: deleteEntry,</span><br><span class="line">  clear,</span><br><span class="line">  <span class="attr">forEach</span>: createForEach(<span class="literal">false</span>, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> iteratorMethods = [<span class="string">&#x27;keys&#x27;</span>, <span class="string">&#x27;values&#x27;</span>, <span class="string">&#x27;entries&#x27;</span>, <span class="built_in">Symbol</span>.iterator]</span><br><span class="line">iteratorMethods.forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">  mutableInstrumentations[method <span class="keyword">as</span> <span class="built_in">string</span>] = createIterableMethod(</span><br><span class="line">    method,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="get"><a href="#get" class="headerlink" title="get"></a>get</h5><p>代理 <code>get</code> 方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取值的方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>proxy 对象 reactive 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>key 获取的key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 是否只读</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isShallow 是否浅代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  target: MapTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">  key: unknown,</span></span></span><br><span class="line"><span class="params"><span class="function">  isReadonly = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  isShallow = <span class="literal">false</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  target = (target <span class="keyword">as</span> <span class="built_in">any</span>)[ReactiveFlags.RAW] <span class="comment">// 获取到原始值 （可能是 reactive 对象） #1772</span></span><br><span class="line">  <span class="keyword">const</span> rawTarget = toRaw(target) <span class="comment">// 获取到最终的原始值</span></span><br><span class="line">  <span class="keyword">const</span> rawKey = toRaw(key) <span class="comment">// 获取 key 的原始值</span></span><br><span class="line">  <span class="keyword">if</span> (key !== rawKey) &#123;</span><br><span class="line">    <span class="comment">// 如果 key 是 reactive 类型，且代理不是 readonly ，收集 key 的依赖</span></span><br><span class="line">    !isReadonly &amp;&amp; track(rawTarget, TrackOpTypes.GET, key)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 再次收集一次依赖 ???</span></span><br><span class="line">  !isReadonly &amp;&amp; track(rawTarget, TrackOpTypes.GET, rawKey)</span><br><span class="line">  <span class="keyword">const</span> &#123; has &#125; = getProto(rawTarget)</span><br><span class="line">  <span class="keyword">const</span> wrap = isReadonly ? toReadonly : isShallow ? toShallow : toReactive</span><br><span class="line">  <span class="comment">// 先获取 key 不是 reactive 的情况</span></span><br><span class="line">  <span class="keyword">if</span> (has.call(rawTarget, key)) &#123;</span><br><span class="line">    <span class="keyword">return</span> wrap(target.get(key))</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (has.call(rawTarget, rawKey)) &#123;</span><br><span class="line">    <span class="keyword">return</span> wrap(target.get(rawKey))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="toReactive"><a href="#toReactive" class="headerlink" title="toReactive"></a>toReactive</h6><p>获取到最终要返回的值的方法，如果是对象/数组类型，返回一个 reactive 类型，否则返回原始值</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toReactive = <span class="xml"><span class="tag">&lt;<span class="name">T</span> <span class="attr">extends</span> <span class="attr">unknown</span>&gt;</span>(value: T): T =&gt;</span></span><br><span class="line"><span class="xml">  isObject(value) ? reactive(value) : value</span></span><br></pre></td></tr></table></figure><h5 id="size"><a href="#size" class="headerlink" title="size"></a>size</h5><p>拦截 <code>.size</code> 的获取</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截 .size 的获取</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>proxy 对象 reactive 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 是否只读</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params">target: IterableCollections, isReadonly = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">  target = (target <span class="keyword">as</span> <span class="built_in">any</span>)[ReactiveFlags.RAW]</span><br><span class="line">  <span class="comment">// 不是  只读 收集依赖</span></span><br><span class="line">  !isReadonly &amp;&amp; track(toRaw(target), TrackOpTypes.ITERATE, ITERATE_KEY)</span><br><span class="line">  <span class="comment">// 返回原始的 size 属性</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, <span class="string">&#x27;size&#x27;</span>, target)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="has"><a href="#has" class="headerlink" title="has"></a>has</h5><p>拦截 <code>has</code> 操作</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截 has 操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>proxy 对象 reactive 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>key 判断的key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 是否只读</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">has</span>(<span class="params"><span class="built_in">this</span>: CollectionTypes, key: unknown, isReadonly = <span class="literal">false</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> target = (<span class="built_in">this</span> <span class="keyword">as</span> <span class="built_in">any</span>)[ReactiveFlags.RAW] <span class="comment">// 获取原始值，可能是一个 reactive 对象</span></span><br><span class="line">  <span class="keyword">const</span> rawTarget = toRaw(target) <span class="comment">// 获取到最终的原始值</span></span><br><span class="line">  <span class="keyword">const</span> rawKey = toRaw(key) <span class="comment">// 获取到 key 的原始值</span></span><br><span class="line">  <span class="keyword">if</span> (key !== rawKey) &#123;</span><br><span class="line">    <span class="comment">// key 是 reactive 类型时，收集 key 的依赖</span></span><br><span class="line">    !isReadonly &amp;&amp; track(rawTarget, TrackOpTypes.HAS, key)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 收集 rawKey 的依赖</span></span><br><span class="line">  !isReadonly &amp;&amp; track(rawTarget, TrackOpTypes.HAS, rawKey)</span><br><span class="line">  <span class="comment">// 先 判断 有没有 reactive 的 key 的值，然后判断 原始值的 key 的值</span></span><br><span class="line">  <span class="keyword">return</span> key === rawKey</span><br><span class="line">    ? target.has(key)</span><br><span class="line">    : target.has(key) || target.has(rawKey)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="add"><a href="#add" class="headerlink" title="add"></a>add</h5><p>拦截 <code>Set</code>/<code>WeakSet</code> 的 add 操作</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截 Set/WeakSet 的 add 操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>proxy 对象 reactive 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>value 添加的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"><span class="built_in">this</span>: SetTypes, value: unknown</span>) </span>&#123;</span><br><span class="line">  value = toRaw(value) <span class="comment">// 获取到 value 的原始值</span></span><br><span class="line">  <span class="keyword">const</span> target = toRaw(<span class="built_in">this</span>) <span class="comment">// 获取 target 的原始值</span></span><br><span class="line">  <span class="keyword">const</span> proto = getProto(target) <span class="comment">//  获取原型</span></span><br><span class="line">  <span class="keyword">const</span> hadKey = proto.has.call(target, value)</span><br><span class="line">  target.add(value) <span class="comment">// 给 set 中添加原始值</span></span><br><span class="line">  <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">    <span class="comment">// 如果 set 中之前没有这个值，触发一次依赖</span></span><br><span class="line">    trigger(target, TriggerOpTypes.ADD, value, value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="set"><a href="#set" class="headerlink" title="set"></a>set</h5><p>拦截 <code>Map</code> 和 <code>WeakMap</code> 的操作</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截 Map 和 WeakMap 的操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>proxy 对象 reactive 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>key key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>value value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="built_in">this</span>: MapTypes, key: unknown, value: unknown</span>) </span>&#123;</span><br><span class="line">  value = toRaw(value) <span class="comment">// 获取到 value 的原始值</span></span><br><span class="line">  <span class="keyword">const</span> target = toRaw(<span class="built_in">this</span>) <span class="comment">// 获取到 target 的原始值</span></span><br><span class="line">  <span class="keyword">const</span> &#123; has, get &#125; = getProto(target)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> hadKey = has.call(target, key) <span class="comment">// boolean 元数据是否存在 key</span></span><br><span class="line">  <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">    key = toRaw(key) <span class="comment">// key 的原始值</span></span><br><span class="line">    hadKey = has.call(target, key) <span class="comment">// 如果没有 reactive 的key ，尝试获取 原始类型的key 是否存在</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="comment">// 开发环境做的操作，忽略</span></span><br><span class="line">    checkIdentityKeys(target, has, key)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> oldValue = get.call(target, key)</span><br><span class="line">  target.set(key, value)</span><br><span class="line">  <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">    <span class="comment">// 触发一次 添加的依赖</span></span><br><span class="line">    trigger(target, TriggerOpTypes.ADD, key, value)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hasChanged(value, oldValue)) &#123;</span><br><span class="line">    <span class="comment">// 触发一次修改的依赖</span></span><br><span class="line">    trigger(target, TriggerOpTypes.SET, key, value, oldValue)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h5><p>拦截 <code>delete</code> 操作</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截 delete 操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>proxy 对象 reactive 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>key key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteEntry</span>(<span class="params"><span class="built_in">this</span>: CollectionTypes, key: unknown</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> target = toRaw(<span class="built_in">this</span>)</span><br><span class="line">  <span class="keyword">const</span> &#123; has, get &#125; = getProto(target)</span><br><span class="line">  <span class="keyword">let</span> hadKey = has.call(target, key)</span><br><span class="line">  <span class="keyword">if</span> (!hadKey) &#123;</span><br><span class="line">    key = toRaw(key)</span><br><span class="line">    hadKey = has.call(target, key)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    checkIdentityKeys(target, has, key)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> oldValue = get ? get.call(target, key) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">const</span> result = target.delete(key)</span><br><span class="line">  <span class="keyword">if</span> (hadKey) &#123;</span><br><span class="line">    <span class="comment">// 如果删除的是之前存在的字段，触发一次 delete 依赖</span></span><br><span class="line">    trigger(target, TriggerOpTypes.DELETE, key, <span class="literal">undefined</span>, oldValue)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="clear"><a href="#clear" class="headerlink" title="clear"></a>clear</h5><p>拦截 <code>clear</code> 操作</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截 clear 操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>this proxy 对象 reactive 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clear</span>(<span class="params"><span class="built_in">this</span>: IterableCollections</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> target = toRaw(<span class="built_in">this</span>)</span><br><span class="line">  <span class="keyword">const</span> hadItems = target.size !== <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> oldTarget = __DEV__</span><br><span class="line">    ? isMap(target)</span><br><span class="line">      ? <span class="keyword">new</span> <span class="built_in">Map</span>(target)</span><br><span class="line">      : <span class="keyword">new</span> <span class="built_in">Set</span>(target)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">const</span> result = target.clear()</span><br><span class="line">  <span class="keyword">if</span> (hadItems) &#123;</span><br><span class="line">    <span class="comment">// 如果之前有元素，触发一次依赖事件</span></span><br><span class="line">    trigger(target, TriggerOpTypes.CLEAR, <span class="literal">undefined</span>, <span class="literal">undefined</span>, oldTarget)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h5><p>拦截 <code>forEach</code> 操作</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拦截 forEach 操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 是否只读</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isShallow 是否浅代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createForEach</span>(<span class="params">isReadonly: <span class="built_in">boolean</span>, isShallow: <span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">forEach</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">this</span>: IterableCollections, <span class="comment">// proxy 对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    callback: <span class="built_in">Function</span>, <span class="comment">// 回调函数</span></span></span></span><br><span class="line"><span class="params"><span class="function">    thisArg?: unknown <span class="comment">// 改变的 this 的值</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> observed = <span class="built_in">this</span> <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">    <span class="keyword">const</span> target = observed[ReactiveFlags.RAW]</span><br><span class="line">    <span class="keyword">const</span> rawTarget = toRaw(target) <span class="comment">// 原始的值</span></span><br><span class="line">    <span class="keyword">const</span> wrap = isReadonly ? toReadonly : isShallow ? toShallow : toReactive</span><br><span class="line">    <span class="comment">// 不是只读，触发一次iterate依赖</span></span><br><span class="line">    !isReadonly &amp;&amp; track(rawTarget, TrackOpTypes.ITERATE, ITERATE_KEY)</span><br><span class="line">    <span class="keyword">return</span> target.forEach(<span class="function">(<span class="params">value: unknown, key: unknown</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// forEach callback 中接收到的值，是 reactive / readonly 类型</span></span><br><span class="line">      <span class="keyword">return</span> callback.call(thisArg, wrap(value), wrap(key), observed)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="keys-、values、entries"><a href="#keys-、values、entries" class="headerlink" title="keys 、values、entries"></a>keys 、values、entries</h5><h6 id="createIterableMethod"><a href="#createIterableMethod" class="headerlink" title="createIterableMethod"></a>createIterableMethod</h6><p>返回一个方法 拦截 <code>iterate</code> 操作，返回一个遍历器，<code>for of</code> 遍历就是基于遍历器实现的</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回一个方法 拦截 iterate 操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>method 方法名称 keys values entries</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isReadonly 是否只读</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>isShallow 是否浅代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createIterableMethod</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  method: <span class="built_in">string</span> | symbol,</span></span></span><br><span class="line"><span class="params"><span class="function">  isReadonly: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  isShallow: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">this</span>: IterableCollections, <span class="comment">// this 是 proxy 对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">    ...args: unknown[]</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Iterable</span> &amp; <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> target = (<span class="built_in">this</span> <span class="keyword">as</span> <span class="built_in">any</span>)[ReactiveFlags.RAW]</span><br><span class="line">    <span class="keyword">const</span> rawTarget = toRaw(target)</span><br><span class="line">    <span class="keyword">const</span> targetIsMap = isMap(rawTarget)</span><br><span class="line">    <span class="comment">// 是否 map 遍历 iterate</span></span><br><span class="line">    <span class="keyword">const</span> isPair =</span><br><span class="line">      method === <span class="string">&#x27;entries&#x27;</span> || (method === <span class="built_in">Symbol</span>.iterator &amp;&amp; targetIsMap)</span><br><span class="line">    <span class="comment">// 是否获取map的keys</span></span><br><span class="line">    <span class="keyword">const</span> isKeyOnly = method === <span class="string">&#x27;keys&#x27;</span> &amp;&amp; targetIsMap</span><br><span class="line">    <span class="keyword">const</span> innerIterator = target[method](...args)</span><br><span class="line">    <span class="keyword">const</span> wrap = isReadonly ? toReadonly : isShallow ? toShallow : toReactive</span><br><span class="line">    <span class="comment">// 收集依赖</span></span><br><span class="line">    !isReadonly &amp;&amp;</span><br><span class="line">      track(</span><br><span class="line">        rawTarget,</span><br><span class="line">        TrackOpTypes.ITERATE,</span><br><span class="line">        isKeyOnly ? MAP_KEY_ITERATE_KEY : ITERATE_KEY</span><br><span class="line">      )</span><br><span class="line">    <span class="comment">// return a wrapped iterator which returns observed versions of the</span></span><br><span class="line">    <span class="comment">// values emitted from the real iterator</span></span><br><span class="line">    <span class="comment">// 返回的是一个next函数，next函数返回 value 和 done ，这是 iterable 接口规范</span></span><br><span class="line">    <span class="comment">// value 的值还是一个 reactive / readonly / ... 的值</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// iterator protocol</span></span><br><span class="line">      <span class="function"><span class="title">next</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; value, done &#125; = innerIterator.next()</span><br><span class="line">        <span class="keyword">return</span> done</span><br><span class="line">          ? &#123; value, done &#125;</span><br><span class="line">          : &#123;</span><br><span class="line">              <span class="attr">value</span>: isPair ? [wrap(value[<span class="number">0</span>]), wrap(value[<span class="number">1</span>])] : wrap(value),</span><br><span class="line">              done</span><br><span class="line">            &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// iterable protocol</span></span><br><span class="line">      [<span class="built_in">Symbol</span>.iterator]() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="shallowReactive-方法"><a href="#shallowReactive-方法" class="headerlink" title="shallowReactive 方法"></a>shallowReactive 方法</h2><p>参数接收一个对象，返回对象的浅代理，通过 <code>createReactiveObject</code> 方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowReactive</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">target: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(</span><br><span class="line">    target,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    shallowReactiveHandlers,</span><br><span class="line">    shallowCollectionHandlers</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="shallowReactiveHandlers"><a href="#shallowReactiveHandlers" class="headerlink" title="shallowReactiveHandlers"></a>shallowReactiveHandlers</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> shallowReactiveHandlers: ProxyHandler&lt;<span class="built_in">object</span>&gt; = extend(</span><br><span class="line">  &#123;&#125;,</span><br><span class="line">  mutableHandlers,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">get</span>: shallowGet,</span><br><span class="line">    <span class="attr">set</span>: shallowSet</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>用了新的 <code>get</code> 和 <code>set</code> 方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shallowGet = <span class="comment">/*#__PURE__*/</span> createGetter(<span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">const</span> shallowSet = <span class="comment">/*#__PURE__*/</span> createSetter(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p>用了上面提到的 <code>createGetter</code> 和 <code>createSetter</code> 方法</p><h3 id="shallowCollectionHandlers"><a href="#shallowCollectionHandlers" class="headerlink" title="shallowCollectionHandlers"></a>shallowCollectionHandlers</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> shallowCollectionHandlers: ProxyHandler&lt;CollectionTypes&gt; = &#123;</span><br><span class="line">  <span class="attr">get</span>: createInstrumentationGetter(<span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用的还是上面提到的 <code>createInstrumentationGetter</code> 方法</p><h2 id="readonly-方法"><a href="#readonly-方法" class="headerlink" title="readonly 方法"></a>readonly 方法</h2><p>参数接收一个对象，返回一个只读 <code>readonly</code> 对象，通过 <code>createReactiveObject</code> 方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">readonly</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  target: T</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">DeepReadonly</span>&lt;<span class="title">UnwrapNestedRefs</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(</span><br><span class="line">    target,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    readonlyHandlers,</span><br><span class="line">    readonlyCollectionHandlers</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="readonlyHandlers"><a href="#readonlyHandlers" class="headerlink" title="readonlyHandlers"></a>readonlyHandlers</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> readonlyHandlers: ProxyHandler&lt;<span class="built_in">object</span>&gt; = &#123;</span><br><span class="line">  <span class="attr">get</span>: readonlyGet,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, key</span>)</span> &#123; <span class="comment">// 不做任何改变，直接返回 true</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(</span><br><span class="line">        <span class="string">`Set operation on key &quot;<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>&quot; failed: target is readonly.`</span>,</span><br><span class="line">        target</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">deleteProperty</span>(<span class="params">target, key</span>)</span> &#123; <span class="comment">// 不做任何改变，直接返回 true</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(</span><br><span class="line">        <span class="string">`Delete operation on key &quot;<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>&quot; failed: target is readonly.`</span>,</span><br><span class="line">        target</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>get</code> 方法 <code>readonlyGet</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> readonlyGet = <span class="comment">/*#__PURE__*/</span> createGetter(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p>使用的是上面提到的 <code>createGetter</code> 方法</p><h3 id="readonlyCollectionHandlers"><a href="#readonlyCollectionHandlers" class="headerlink" title="readonlyCollectionHandlers"></a>readonlyCollectionHandlers</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> readonlyCollectionHandlers: ProxyHandler&lt;CollectionTypes&gt; = &#123;</span><br><span class="line">  <span class="attr">get</span>: createInstrumentationGetter(<span class="literal">true</span>, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用的 <code>createInstrumentationGetter</code> 方法，创建的 <code>handle</code> 对象</p><h2 id="shallowReadonly-方法"><a href="#shallowReadonly-方法" class="headerlink" title="shallowReadonly 方法"></a>shallowReadonly 方法</h2><p>参数接收一个对象，返回一个只读 <code>readonly</code> 的对象，这个只读，只针对对象的第一层，不做深层的代理， 通过 <code>createReactiveObject</code> 方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowReadonly</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  target: T</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Readonly</span>&lt;</span>&#123; [K <span class="keyword">in</span> keyof T]: UnwrapNestedRefs&lt;T[K]&gt; &#125;&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> createReactiveObject(</span><br><span class="line">    target,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    shallowReadonlyHandlers,</span><br><span class="line">    readonlyCollectionHandlers</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="shallowReadonlyHandlers"><a href="#shallowReadonlyHandlers" class="headerlink" title="shallowReadonlyHandlers"></a>shallowReadonlyHandlers</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> shallowReadonlyHandlers: ProxyHandler&lt;<span class="built_in">object</span>&gt; = extend(</span><br><span class="line">  &#123;&#125;,</span><br><span class="line">  readonlyHandlers,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">get</span>: shallowReadonlyGet</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>get</code> 方法 <code>shallowReadonlyGet</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shallowReadonlyGet = <span class="comment">/*#__PURE__*/</span> createGetter(<span class="literal">true</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure><h3 id="readonlyCollectionHandlers-1"><a href="#readonlyCollectionHandlers-1" class="headerlink" title="readonlyCollectionHandlers"></a>readonlyCollectionHandlers</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> readonlyCollectionHandlers: ProxyHandler&lt;CollectionTypes&gt; = &#123;</span><br><span class="line">  <span class="attr">get</span>: createInstrumentationGetter(<span class="literal">true</span>, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面已经提到过</p><h3 id="createReactiveObject-方法"><a href="#createReactiveObject-方法" class="headerlink" title="createReactiveObject 方法"></a>createReactiveObject 方法</h3><p>参数</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>target</td><td>需要代理的源数据（一般是对象，可以是Map/Set/WeakMap/WeakSet）</td></tr><tr><td>isReadonly</td><td>是否创建只读对象</td></tr><tr><td>baseHandlers</td><td>target 是 Object/Array 时，proxy 的 handle 对象</td></tr><tr><td>collectionHandlers</td><td>target 是 Map/Set/WeakMap/WeakSet时，proxy 的 handle 对象</td></tr></tbody></table><p>返回一个 <code>proxy</code> 对象，会对返回的 <code>proxy</code> 和 <code>target</code> 做一个缓存，如果对同一个对象多次调用该方法，获取到的是同一个对象</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createReactiveObject</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  target: Target,</span></span></span><br><span class="line"><span class="params"><span class="function">  isReadonly: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  baseHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  collectionHandlers: ProxyHandler&lt;<span class="built_in">any</span>&gt;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果不是对象类型，就直接返回 参数本身</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(target)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">`value cannot be made reactive: <span class="subst">$&#123;<span class="built_in">String</span>(target)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果target是只读对象，并且要获取只读对象的时候，就直接返回 target</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    target[ReactiveFlags.RAW] &amp;&amp;</span><br><span class="line">    !(isReadonly &amp;&amp; target[ReactiveFlags.IS_REACTIVE])</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果 target 已经有了对象的代理对象，直接返回这个代理</span></span><br><span class="line">  <span class="keyword">const</span> proxyMap = isReadonly ? readonlyMap : reactiveMap</span><br><span class="line">  <span class="keyword">const</span> existingProxy = proxyMap.get(target)</span><br><span class="line">  <span class="keyword">if</span> (existingProxy) &#123;</span><br><span class="line">    <span class="keyword">return</span> existingProxy</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * targetType 指定要跳过或者不可扩展，或者不是Object/Array/Map/WeakMap/Set/WeakSet TargetType.INVALID</span></span><br><span class="line"><span class="comment">   * Object/Array TargetType.COMMON</span></span><br><span class="line"><span class="comment">   * Map/Set/WeakMap/WeakSet TargetType.COLLECTION</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> targetType = getTargetType(target)</span><br><span class="line">  <span class="keyword">if</span> (targetType === TargetType.INVALID) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(</span><br><span class="line">    target,</span><br><span class="line">    targetType === TargetType.COLLECTION ? collectionHandlers : baseHandlers</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 保存一下这个代理对象</span></span><br><span class="line">  proxyMap.set(target, proxy)</span><br><span class="line">  <span class="keyword">return</span> proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="isReactive-方法"><a href="#isReactive-方法" class="headerlink" title="isReactive 方法"></a>isReactive 方法</h2><p>通过 <code>ReactiveFlags.IS_REACTIVE</code> / <code>__v_isReactive</code> 属性判断是不是 <code>reactive</code> 对象，这个对象的获取在 <code>proxy</code> 的 <code>handle</code> 中做了处理</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReactive</span>(<span class="params">value: unknown</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isReadonly(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span> isReactive((value <span class="keyword">as</span> Target)[ReactiveFlags.RAW])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> !!(value &amp;&amp; (value <span class="keyword">as</span> Target)[ReactiveFlags.IS_REACTIVE])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> b = Vue.reactive(&#123;<span class="attr">a</span>: <span class="number">123</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isReactive(b)) <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isReactive(&#123;<span class="attr">__v_isReactive</span>: <span class="literal">true</span>&#125;)) <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isReactive(&#123;<span class="attr">__v_isReactive</span>: <span class="number">1</span>&#125;)) <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="isReadonly-方法"><a href="#isReadonly-方法" class="headerlink" title="isReadonly 方法"></a>isReadonly 方法</h2><p>通过 <code>ReactiveFlags.IS_READONLY</code> / <code>__v_isReadonly</code> 判断是否是 <code>readonly</code> 类型</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isReadonly</span>(<span class="params">value: unknown</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!(value &amp;&amp; (value <span class="keyword">as</span> Target)[ReactiveFlags.IS_READONLY])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> b = Vue.readonly(&#123;<span class="attr">a</span>: <span class="number">123</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isReadonly(b)) <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isReadonly(&#123;<span class="attr">__v_isReadonly</span>: <span class="literal">true</span>&#125;)) <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isReadonly(&#123;<span class="attr">__v_isReadonly</span>: <span class="number">1</span>&#125;)) <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="isProxy-方法"><a href="#isProxy-方法" class="headerlink" title="isProxy 方法"></a>isProxy 方法</h2><p>判断数据是不是 <code>reactive</code> 或者 <code>readonly</code> 类型的数据</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isProxy</span>(<span class="params">value: unknown</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isReactive(value) || isReadonly(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = Vue.reactive(&#123;<span class="attr">a</span>: <span class="number">123</span>&#125;)</span><br><span class="line">    <span class="keyword">const</span> b = Vue.readonly(&#123;<span class="attr">a</span>: <span class="number">123</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isProxy(a)) <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isProxy(b)) <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isProxy(&#123;<span class="attr">__v_isReadonly</span>: <span class="literal">true</span>&#125;)) <span class="comment">// true</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.isProxy(&#123;<span class="attr">__v_isReactive</span>: <span class="literal">true</span>&#125;)) <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="toRaw-方法"><a href="#toRaw-方法" class="headerlink" title="toRaw 方法"></a>toRaw 方法</h2><p>方法接收一个参数，如果参数是 <code>reactive</code> / <code>readonly</code> 对象会返回 <code>reactive</code> 对象的原始值，如果不是 <code>reactive</code> 对象，就返回接收的参数</p><p><code>ReactiveFlags.RAW</code> 在 <code>reactive</code> 对象的 <code>get</code> 方法中做了处理</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toRaw</span>&lt;<span class="title">T</span>&gt;(<span class="params">observed: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    (observed &amp;&amp; toRaw((observed <span class="keyword">as</span> Target)[ReactiveFlags.RAW])) || observed</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> a = Vue.reactive(&#123;<span class="attr">a</span>: <span class="number">123</span>&#125;)</span><br><span class="line">    <span class="keyword">const</span> b = Vue.readonly(&#123;<span class="attr">b</span>: <span class="number">123</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(Vue.toRaw(a)) <span class="comment">// &#123;a: 123&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.toRaw(b)) <span class="comment">// &#123;b: 123&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.toRaw(&#123;<span class="attr">__v_isReadonly</span>: <span class="literal">true</span>&#125;)) <span class="comment">// &#123;__v_isReadonly: true&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.toRaw(&#123;<span class="attr">__v_isReactive</span>: <span class="literal">true</span>&#125;)) <span class="comment">// &#123;__v_isReactive: true&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="markRaw-方法"><a href="#markRaw-方法" class="headerlink" title="markRaw 方法"></a>markRaw 方法</h2><p>接收一个参数对象，标记这个对象是不需要代理的，通过 <code>ReactiveFlags.SKIP</code> / <code>__v_skip</code> 实现，会给对象添加一个 <code>__v_skip</code> 属性，值是 <code>true</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markRaw</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params">value: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  def(value, ReactiveFlags.SKIP, <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> a = Vue.markRaw(&#123;<span class="attr">a</span>: <span class="number">123</span>&#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(a) <span class="comment">// &#123;a: 123, __v_skip: true&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.reactive(&#123;<span class="attr">a</span>: <span class="number">123</span>&#125;)) <span class="comment">// Proxy &#123;a: 123&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.reactive(a)) <span class="comment">// &#123;a: 123, __v_skip: true&#125;</span></span><br><span class="line">    <span class="built_in">console</span>.log(Vue.reactive(&#123;<span class="attr">__v_skip</span>: <span class="literal">true</span>&#125;)) <span class="comment">// &#123;__v_skip: true&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://wukang0718.com/2022/09/02/reactive%E6%BA%90%E7%A0%81/" title="reactive源码" target="_blank" rel="external">https://wukang0718.com/2022/09/02/reactive源码/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/wukang0718" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpeg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/wukang0718" target="_blank"><span class="text-dark">武康</span><small class="ml-1x">前端开发</small></a></h3><div>一个做前端开发的小学生</div></div></figure></div></div></div></article><section id="comments"><div id="giteement-container"></div><script src="https://giteement.oss-cn-beijing.aliyuncs.com/giteement.browser.js"></script><script type="text/javascript">var giteement=new Giteement({id:"20220902165927",owner:"wu_kang0718",repo:"blog-comment",backcall_uri:"http://wukang0718.com/",oauth_uri:"https://gitee.com/oauth/token",oauth:{client_id:"1e89d65cfe088358a5f44772dc916637ff4937d55991cc6534794feeb4464e4c",client_secret:"ff05c5c3967366b088409de5616065ebcfbe35be6f65a241b636093385215546"}});giteement.render("giteement-container")</script></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2022/09/02/ref%E6%BA%90%E7%A0%81/" title="ref源码"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2022/09/02/computed%E6%BA%90%E7%A0%81/" title="computed源码"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="wechat,weibo,qq,facebook,twitter" data-mobile-sites="wechat,weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.jpg" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.jpg" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/wukang0718" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>